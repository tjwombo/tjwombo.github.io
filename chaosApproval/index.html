<!DOCTYPE html>
<html onmouseup="stopEl()" onmousemove="moveEl()" onmouseleave="stopEl()">
<body>
<head>
<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
<script src="https://embed.twitch.tv/embed/v1.js"></script>
<button id="start" onclick="myFunction()">Start</button>
</head>
<h1 id="error"> </h1>
<div id="text" onmousedown="return false" style="user-select:none; display:inline-block"> </div>

<script>
// client that makes connection requests
var oauth = document.location.hash.split("&")[0].split("=")[1];
var peer = new Peer('womboModCheck '+ oauth);
peer.on('open', function(id) {
	console.log('My peer ID is: ' + id);
});
var c;
var verified = false;
var ratio = 0 // width being numerator
var isStatic = false;
var src = "";
var orgSrc = "";
const message = ". Hit enter to see dimension change. 0 to reset scale (but not double 0)";
const screenCompression = 1.16504854368932;
var move = false;
var offset = [];

peer.on('error', function(err) { console.log(err); });

function myFunction() {
    c = peer.connect('womboModServer');

    c.on('open', function() {
        c.on('data', function(data) {
            if (verified) {
                if (data == null) {
                    return;
                }
                console.log(data);
                console.log(data[1].node);
                if (data[0] != "womboModServer") {
                    return;
                }
                var div = document.createElement("div");
                div.onmousedown = "return false";
                div.style = "display: inline-block; user-select: none";
                var inpt = document.createElement("input");
                inpt.type = "text";
                inpt.id = "w";
                inpt.name = "w";
                inpt.style = "user-select: none";
                inpt.onchange = "changeW(this.value)";
                document.body.appendChild(inpt);
                var label = document.createElement("label");
                label.innerHTML = "Width:";
                label.htmlFor = "w";
                div.appendChild(label);
                document.body.insertBefore(div, inpt);

                div = document.createElement("div");
                div.onmousedown = "return false";
                div.style = "display: inline-block; user-select: none";
                inpt = document.createElement("input");
                inpt.type = "text";
                inpt.id = "w";
                inpt.name = "w";
                inpt.style = "user-select: none";
                inpt.onchange = "changeH(this.value)";
                document.body.appendChild(inpt);
                label = document.createElement("label");
                label.innerHTML = "Height:";
                label.htmlFor = "h";
                div.appendChild(label);
                document.body.insertBefore(div, inpt);

                div = document.createElement("div");
                div.onmousedown = "return false";
                div.style = "display: inline-block; user-select: none";
                inpt = document.createElement("input");
                inpt.type = "text";
                inpt.id = "l";
                inpt.name = "l";
                inpt.stlye = "user-select: none";
                inpt.onchange = "changeL(this.value)";
                document.body.appendChild(inpt);
                label = document.createElement("label");
                label.innerHTML = "Line:";
                label.htmlFor = "l";
                div.appendChild(label);
                document.body.insertBefore(div, inpt);

                div = document.createElement("div");
                div.id = "c";
                div.style = "position:absolute; z-index: 100";
                div.draggable = false;
                div.onmousedown = "readyTransform()";
                var img = document.createElement("img");
                img.id = "1";
                try {
                    img.src = data[1].node[0];
                } catch (err) {
                    img.src = "";
                }
                img.draggable = false;
                src = img.src;
                orgSrc = src;
                div.appendChild(img);

                div = document.createElement("div");
                div.onmousedown = "return false";
                div.style = "user-select:none; display: flex";
                var ig = document.createElement("img");
                ig.src= "https://hips.hearstapps.com/hmg-prod/images/red-fresh-apple-isolated-on-white-background-royalty-free-image-1627314996.jpg";
                ig.style = "opacity:0; position:absolute";
                ig.width = 1652;
                ig.height = 931;
                ig.draggable = false;
                div.appendChild(ig);
                var ifame = document.createElement("iframe");
                ifame.id = "i";
                ifame.src = "https://player.twitch.tv/?channel=tjwombo&parent=tjwombo.github.io";
                ifame.height = 927;
                ifame.width = 1648;
                div.appendChild(ifame);
                var div2 = document.createElement("div");
                div2.style = "float: right; display: flex; flex-direction: column; user-select: none";
                div2.onmousedown = "return false";
                var but = document.createElement("button");
                but.id = "rp";
                but.type = "button";
                but.onclick = "buttonRP()";
                but.innerHTML = "Reset Position";
                div2.appendChild(but);
                but = document.createElement("button");
                but.id = "rl";
                but.type = "button";
                but.onclick = "buttonRL()";
                but.innerHTML = "Reset Link";
                div2.appendChild(but);
                but = document.createElement("button");
                but.id = "pr";
                but.type = "button";
                but.onclick = "buttonPR()";
                but.innerHTML = "Random Position";
                div2.appendChild(but);
                but = document.createElement("button");
                but.id = "a";
                but.type = "button";
                but.onclick = "buttonA()";
                but.innerHTML = "Accept";
                div2.appendChild(but);
                but = document.createElement("button");
                but.id = "d";
                but.type = "button";
                but.onclick = "buttonD()";
                but.innerHTML = "Deny";
                div2.appendChild(but);
                div.appendChild(div2);
                document.body.appendChild(div);

                //img.style.display = "";
                //document.getElementById("wLabel").style.display = "";
                //document.getElementById("w").style.display = "";
                //document.getElementById("hLabel").style.display = "";
                //document.getElementById("h").style.display = "";
                //document.getElementById("lLabel").style.display = "";
                //document.getElementById("l").style.display = "";
                //document.getElementById("rp").style.display = "";
                //document.getElementById("rl").style.display = "";
                //document.getElementById("a").style.display = "";
                //document.getElementById("d").style.display = "";
                try {
                    if (data[1].node[1] == "img") {
                        isStatic = true;
                        stopAnimatedGifs("1");
                    }
                } catch (err) {}
                img.onload = function() {
                    console.log(img.width);
                    console.log(img.height);
                    img.width = Math.floor(img.width / screenCompression);
                    console.log(img.width);
                    console.log(img.height);
                    document.getElementById("text").innerHTML = "Original dimensions: " + img.width + "x" +img.height + message;
                    ratio = img.width / img.height;		        
                }
                document.getElementById("l").value = src;
            } else {
                console.log(data);
                if (typeof data == "string") {				
                    if (data.includes("good")) {
                        verified = true;
                        //document.getElementById("1").style.visibility = "";	
                    } else if (data == "Ready") {
                        c.send("Ready");
                    }
                } else {
                    console.log('bad', data);
                    c.close();
                    peer.destroy();
                    document.getElementById("error").innerHTML = "Retry as you aren't a mod or you didn't authorize twitch";
                    return;
                }
            }
            console.log('Received', data);
        });
    });
    c.send("Ready");
    c.on('close', function() {
        console.log("connection closed");
    });
    document.getElementById("start").remove();
    document.getElementById("error").remove();
    move = false;
}

// Code to prevent gifs to being played. Use when static is redememd incase they try to send a gif
function getCanvas(){
    canvas = document.createElement('canvas');
    canvas.id = "1";
    document.getElementById("c").appendChild(canvas);
    canvas.ctx = canvas.getContext('2d');
    return canvas;
};

function preventAnimation( gif ){
    var self = arguments.callee;
    canvas = getCanvas();
    var w = gif.width;
    var h =  gif.height;
    canvas.width  = w;
    canvas.height = h;
    canvas.ctx.drawImage( gif, 0, 0, w, h);
    parent = gif.parentNode;
    parent.replaceChild( canvas, gif );
};

function stopAnimatedGifs(ids){
     // make sure the images are fully loaded before preventing animation
     var images = document.images;
     var i = images.length;
     while( ( image = images[ --i ] ) ){
          var src = image.src;
          if( (/\.gif/).test( src ) && ids.includes(image.id)){
               var gif = new Image()
               gif.onload = (function( img ){ 
                    return function(){ preventAnimation( img ) }
               })( image );
               gif.src = src;
          };  
     };
};
function changeW(val) {
    if (isStatic) {
        var canvas = document.getElementById("1");
        var height = canvas.height;
        var width = canvas.width;
        canvas.remove();
        img = document.createElement('img');
        img.id = "1";
        img.src = src;
        img.draggable = false;
        document.getElementById("c").appendChild(img);
        if (document.getElementById("h").value == 0) {
            document.getElementById("1").height = val / ratio;
        } else if (val == 0) {
            document.getElementById("1").width = height * ratio;
        } else {
            document.getElementById("1").width = val;
            document.getElementById("1").height = height;
        }
        stopAnimatedGifs("1");
    } else {
        if (val == 0) {
            document.getElementById("1").width = height * ratio;
        } else {
            document.getElementById("1").width = val;
        }
    }
}

function changeH(val) {
    if (isStatic) {
        var canvas = document.getElementById("1");
        var height = canvas.height;
        var width = canvas.width;
        canvas.remove();
        img = document.createElement('img');
        img.id = "1";
        img.src = src;
        img.draggable = false;
        document.getElementById("c").appendChild(img);
        if (document.getElementById("w").value == 0) {
            document.getElementById("1").width = val * ratio;
        } else if (val == 0) {
            document.getElementById("1").height = width / ratio;
        } else {
            document.getElementById("1").height = val;
            document.getElementById("1").width = width;
        }
        stopAnimatedGifs("1");
    } else {
        if (val == 0) {
            document.getElementById("1").height = width / ratio;
        } else {
            document.getElementById("1").height = val;
        }
    }
}

function changeL(val) {
    var img = document.createElement('img');
    src = val;
    if (isStatic) {
        img.src = src;
        var canvas = document.getElementById("1");
        var h = canvas.height;
        var w = canvas.width;
        canvas.remove();
        img.id = "1";
        img.draggable = false;
        img.onload = function() {
            document.getElementById("text").innerHTML = "Original dimensions: " + (Math.floor(img.width/screenCompression)) + "x" + (Math.floor(img.height/screenCompression)) + message;
	    ratio = img.width / img.height;	
            img.height = h;
            img.width = w;
        }
        document.getElementById("c").appendChild(img);
        stopAnimatedGifs("1");
    } else {
	var oldImg = document.getElementById("1");
        oldImg.src = src;
        img.onload = function() {
            document.getElementById("text").innerHTML = "Original dimensions: " + (img.width/screenCompression) + "x" + (img.height/screenCompression) + message;
	    ratio = img.width / img.height;	
	    oldImg.height = img.height;
	    oldImg.width = img.width;
	    img.remove();
        }
    }
}

function buttonA() {
    var img = document.getElementById("1");
    var can = document.getElementById("c");
    c.send(["Accept", img.src, (img.width*screenCompression), (img.height*screenCompression), can.style.left, can.style.top]); // going to need to modify this in respects to the players coords
}

function buttonD() {
    c.send(["Deny"]);
}

function readyTransform() {
    var pos = document.getElementById("c").getBoundingClientRect();
    move = true;
    offset = [event.clientX - pos.x, event.clientY - pos.y];
}

function stopEl() {
    move = false;
}

function moveEl() {
    if (move == true) {
        var el = document.getElementById("c");
        el.style.left = (event.clientX - offset[0]) + "px";
        el.style.top = (event.clientY - offset[1]) + "px";
    }
}

function buttonRP() {
    var el = document.getElementById("c");
    el.style.left = "0px";
    el.style.top = "0px";
}

function buttonRL() {
    document.getElementById("l").value = orgSrc;
    changeL(orgSrc);
}

function buttonPR() {
    var el = document.getElementById("c");
    el.style.left = (Math.floor(Math.random() * 1649) + 9) + "px";
    el.style.top = (Math.floor(Math.random() * 928) + 50) + "px";
}
</script>
</body>
</html>