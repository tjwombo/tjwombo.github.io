<!DOCTYPE html>
<html onmouseup="stopEl()" onmousemove="moveEl()">
<body>
<head>
<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
<script src="https://embed.twitch.tv/embed/v1.js"></script>
<button id="start" onclick="myFunction()">Start</button>
</head>
<h1 id="error"> </h1>
<div id="text" onmousedown="return false"> </div>
<div onmousedown="return false"><label for="w" id="wLabel" style="display: none;">Width:</label></div>
<input type="text" id="w" name="w" style="display: none;" onchange="changeW(this.value)">
<div onmousedown="return false"><label for="h" id="hLabel" style="display: none;">Height:</label></div>
<input type="text" id="h" name="h" style="display: none;" onchange="changeH(this.value)">
<br>
<div onmousedown="return false"><label for="l" id="lLabel" style="display:none;">Link:</label></div>
<input type="text" id="l" name="l" style="display: none;" onchange="changeL(this.value)" size="50">
<div onmousedown="return false">
<button id="r"" style="display: none;" type="button" onclick="buttonR">Reset</button>
<br>
<div id="c" style="position:absolute;" draggable="false" onmousedown="readyTransform()">
<img id="1" src="" alt="No Images Yet" style="display: none; position:absolute;" draggable="false">
</div>
<iframe id="i" src="https://player.twitch.tv/?channel=tjwombo&parent=tjwombo.github.io" height=562.5 width=1000></iframe>
<br>
<button id="a" style="display: none;" type="button" onclick="buttonA()">Click Me!</button>
<button id="d" style="display: none;" type="button" onclick="buttonD()">Click Me!</button>
</div>

<script>
// client that makes connection requests
var oauth = document.location.hash.split("&")[0].split("=")[1];
var peer = new Peer('womboModCheck '+ oauth);
peer.on('open', function(id) {
	console.log('My peer ID is: ' + id);
});
var c;
var verified = false;
var ratio = 0 // width being numerator
var isStatic = false;
var src = "";
const message = ". Hit enter to see dimension change. 0 to reset scale (but not double 0)";
var move = false;
var offset = [];

peer.on('error', function(err) { console.log(err); });

function myFunction() {
    c = peer.connect('womboModServer');

    c.on('open', function() {
        c.on('data', function(data) {
            if (verified) {
                var img = document.getElementById("1");
                if (data == null) {
                    return;
                }
                console.log(data);
                console.log(data[1].node);
                if (data[0] != "womboModServer") {
                    return;
                }
                try {
                    img.src = data[1].node[0];
                } catch (err) {
                    img.src = "";
                }
                src = img.src;
                img.style.display = "";
                document.getElementById("wLabel").style.display = "";
                document.getElementById("w").style.display = "";
                document.getElementById("hLabel").style.display = "";
                document.getElementById("h").style.display = "";
                document.getElementById("lLabel").style.display = "";
                document.getElementById("l").style.display = "";
                document.getElementById("r").style.display = "";
                document.getElementById("a").style.display = "";
                document.getElementById("d").style.display = "";
                if (data[1].node[1] == "img") {
                    isStatic = true;
                    stopAnimatedGifs("1");
                }
                img.onload = function() {
                    document.getElementById("text").innerHTML = "Original dimensions: " + img.width + "x" +img.height + message;
                    ratio = img.width / img.height;		        
                }
                document.getElementById("l").value = src;
            } else {
                console.log(data);
                if (typeof data == "string") {				
                    if (data.includes("good")) {
                        verified = true;
                        document.getElementById("1").style.visibility = "";	
                    } else if (data == "Ready") {
                        c.send("Ready");
                    }
                } else {
                    console.log('bad', data);
                    c.close();
                    peer.destroy();
                    document.getElementById("error").innerHTML = "Retry as you aren't a mod or you didn't authorize twitch";
                    return;
                }
            }
            console.log('Received', data);
        });
    });
    c.send("Ready");
    c.on('close', function() {
        console.log("connection closed");
    });
    document.getElementById("start").remove();
    document.getElementById("error").remove();
    move = false;
}

// Code to prevent gifs to being played. Use when static is redememd incase they try to send a gif
function getCanvas(){
    canvas = document.createElement('canvas');
    canvas.id = "1";
    document.getElementById("c").appendChild(canvas);
    canvas.ctx = canvas.getContext('2d');
    return canvas;
};

function preventAnimation( gif ){
    var self = arguments.callee;
    canvas = getCanvas();
    var w = gif.width;
    var h =  gif.height;
    canvas.width  = w;
    canvas.height = h;
    canvas.ctx.drawImage( gif, 0, 0, w, h);
    parent = gif.parentNode;
    parent.replaceChild( canvas, gif );
};

function stopAnimatedGifs(ids){
     // make sure the images are fully loaded before preventing animation
     var images = document.images;
     var i = images.length;
     while( ( image = images[ --i ] ) ){
          var src = image.src;
          if( (/\.gif/).test( src ) && ids.includes(image.id)){
               var gif = new Image()
               gif.onload = (function( img ){ 
                    return function(){ preventAnimation( img ) }
               })( image );
               gif.src = src;
          };  
     };
};
function changeW(val) {
    if (isStatic) {
        var canvas = document.getElementById("1");
        var height = canvas.height;
        var width = canvas.width;
        canvas.remove();
        img = document.createElement('img');
        img.id = "1";
	console.log(src);
        img.src = src;
        document.getElementById("c").appendChild(img);
        if (document.getElementById("h").value == 0) {
            document.getElementById("1").height = val / ratio;
        } else if (val == 0) {
            document.getElementById("1").width = height * ratio;
        } else {
            document.getElementById("1").width = val;
            document.getElementById("1").height = height;
        }
        stopAnimatedGifs("1");
    } else {
        if (val == 0) {
            document.getElementById("1").width = height * ratio;
        } else {
            document.getElementById("1").width = val;
        }
    }
}

function changeH(val) {
    if (isStatic) {
        var canvas = document.getElementById("1");
        var height = canvas.height;
        var width = canvas.width;
        canvas.remove();
        img = document.createElement('img');
        img.id = "1";
        img.src = src;
        document.getElementById("c").appendChild(img);
        if (document.getElementById("w").value == 0) {
            document.getElementById("1").width = val * ratio;
        } else if (val == 0) {
            document.getElementById("1").height = width / ratio;
        } else {
            document.getElementById("1").height = val;
            document.getElementById("1").width = width;
        }
        stopAnimatedGifs("1");
    } else {
        if (val == 0) {
            document.getElementById("1").height = width / ratio;
        } else {
            document.getElementById("1").height = val;
        }
    }
}

function changeL(val) {
    src = val;
    var img = document.createElement('img');
    img.src = src;
    if (isStatic) {
        var canvas = document.getElementById("1");
        canvas.remove();
        img.id = "1";
        ratio = img.width / img.height;
        img.onload = function() {
            document.getElementById("text").innerHTML = "Original dimensions: " + img.width + "x" +img.height + message;
	    ratio = img.width / img.height;	
            img.height = canvas.height;
            img.width = canvas.width;
        }
        document.getElementById("c").appendChild(img);
        stopAnimatedGifs("1");
    } else {
	var oldImg = document.getElementById("1");
        oldImg.src = src;
        img.onload = function() {
            document.getElementById("text").innerHTML = "Original dimensions: " + img.width + "x" +img.height + message;
	    ratio = img.width / img.height;	
	    oldImg.height = img.height;
	    oldImg.width = img.width;
	    img.remove();
        }
    }
}

function buttonA() {
    var img = document.getElementById("1");
    c.send(["Accept", img.src, img.width, img.height, img.style.left, img.style.top]);
}

function buttonD() {
    c.send(["Deny"]);
}

function readyTransform() {
    var pos = document.getElementById("c").getBoundingClientRect();
    move = true;
    offset = [event.clientX - pos.x, event.clientY - pos.y];
    console.log("ready");
}

function stopEl() {
    move = false;
}

function moveEl() {
    if (move == true) {
        var el = document.getElementById("c");
        el.style.left = (event.clientX - offset[0]) + "px";
        el.style.top = (event.clientY - offset[1]) + "px";
    }
}
</script>
</body>
</html>