<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>If you're not OBS, Go Away</title>
  <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
</head>

<body>

<h1 id="error"> </h1>
<button id="butt" onclick="removeButton()" >Click to start</button>

<script>

    var key = "";

    function removeButton() {
        key = document.location.hash.split("&")[0].split("=")[1];
        setUp();
    }

    var userMap = new Map();
    const cap = .1

    function switchDecay(shroom) {
        console.log("decay");
        shroom.state = 1;
        document.getElementById(shroom.user).src = "./src/decay.PNG"
        shroom.setTimer();
    }

    function removeShroom(user) {
        console.log("remove");
        document.getElementById(user).remove();
        userMap.delete(user);
    }

    class ShroomState {
        constructor(u) {
            this.state = -1;
            this.user = u;
            this.scale = 0;
        }

        setTimer() {
            if (this.timer != null) {
                clearTimeout(this.timer);
            }
            if (this.state == 0) {
                this.timer = setTimeout(switchDecay, 600000, this); // 10 minutes
            } else if (this.state == 1) {
                this.timer = setTimeout(removeShroom, 120000, this.user); // 2 minutes
            }
        }
    }

    function setUp() {
        // Connect to the channel to read channel point redemptions
        try {
            ComfyJS.Init( "straybard", key);

            document.getElementById("butt").remove();

            ComfyJS.onReward = ( user, reward, cost, message, extra ) => {
                if (reward == "shroom") {
                    if (!userMap.has(user)) {
                        var shroom = new ShroomState(user);
                        var img = document.createElement("img");
                        img.src = "./src/init.PNG"
                        img.id = user;
                        document.body.appendChild(img);
                        userMap.set(user, shroom);
                        shroom.setTimer();
                    }
                } else if (reward == "grow") {
                    if (!userMap.has(user)) {
                        return;
                    }
                    var shroom = userMap.get(user);
                    if (shroom.state == 0) {
                       if (shroom.scale == cap) {
                           document.getElementById(user).src = "./src/super.PNG";
                       } else {
                           shroom.scale = shroom.scale + .01;
                           document.getElementById(user).style.transform = "scale(" + (1+shroom.scale) + ")";
                       }
                    } else if (shroom.state == 1) {
                        shroom.state = 0;
                        document.getElementById(user).src = "./src/init.PNG";
                    } else if (shroom.state == -1) {
                        shroom.state = 0;
                    }
                    shroom.setTimer();
                }
            }
        } catch (err) {
            error.innerHTML = "failed connection: " + err;
        }
    }
</script>
</body>
</html>

