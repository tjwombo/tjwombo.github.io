<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>If you're not OBS, Go Away</title>
  <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
  <style>
  
    .image {
        width: 1920px;
        height: 1080px;
        display: none;
        background-color: #ccc;
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        opacity: 0.0;
    }

  </style>
</head>

<body>

<h1 id="error"> </h1>
<button id="butt" onclick="removeButton()" >Click to start</button>

<script>

    var key = "";

    function removeButton() {
        key = document.location.hash.split("&")[0].split("=")[1];
        setUp();
    }

    var random = 0;
    var userMap = new Map();

    class ShroomState {
        constructor(u) {
            this.state = 0;
            this.user = u;
        }

        setTimer() {
            if (this.state == 0) {
                this.timer = setTimeout(function(){
                                 console.log("decay");
                                 this.state = 1;
                             }, 0);
            } else if (this.state == 1) {
                this.timer = setTimeout(this.removeShroom, 0); // 2 minutes
            }
        }

        switchDecay() {
            console.log("decay");
            this.state = 1;
        }

        removeShroom() {
            console.log("remove");
        }
    }

    function setUp() {
        // Connect to the channel to read channel point redemptions
        try {
            ComfyJS.Init( "tjwombo", key);

            document.getElementById("butt").remove();

            ComfyJS.onReward = ( user, reward, cost, message, extra ) => {
                // Play a random fnaf jumpscare
                if (reward == "Jumpscare") {
                    var shroom;
                    if (userMap.has(user)) {
                        shroom = userMap.get(user);
                        shroom.setTimer();
                    } else {
                        shroom = new ShroomState(user);
                        var img = document.createElement("img");
                        img.src = "./src/init.PNG"
                        img.id = user;
                        document.body.appendChild(img);
                        shroom.setTimer();
                        userMap.set(user, shroom);
                        return;
                    }
                }
            }
        } catch (err) {
            error.innerHTML = "failed connection: " + err;
        }
    }
</script>
</body>
</html>

